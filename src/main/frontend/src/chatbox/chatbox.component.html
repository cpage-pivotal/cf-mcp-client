<div class="chatbox" id="chatbox">
  <div #chatboxMessages class="chatbox-messages">
    <!-- Chat messages will be dynamically inserted here -->
    @for (messageData of messagesWithReasoningFlags(); track messageData.index) {
      <div class="chat-message {{messageData.persona}}">
        <mat-card appearance="outlined"
                  [attr.data-card-variant]="messageData.persona == 'user' ? 'user' : 'bot'"
                  class="md3-chat-card">
          <mat-card-content>
            @if (messageData.persona == 'user') {
              <div class="user-message-content">{{ messageData.text }}</div>
            } @else {
              <div class="bot-message-container">
                @if (messageData.typing) {
                  <div class="typing__dot"></div><div class="typing__dot"></div><div class="typing__dot"></div>
                } @else {
                  <div class="main-content">
                    <markdown [data]="messageData.text"></markdown>
                  </div>
                  @if (messageData.hasReasoning && messageData.reasoning) {
                    <mat-expansion-panel class="reasoning-expansion-panel"
                                       [expanded]="messageData.showReasoning"
                                       (expandedChange)="toggleReasoning(messageData.index)">
                      <mat-expansion-panel-header>
                        <mat-panel-title>
                          <mat-icon class="reasoning-icon">psychology</mat-icon>
                          <span class="reasoning-title">Reasoning</span>
                        </mat-panel-title>
                      </mat-expansion-panel-header>
                      <div class="reasoning-content">
                        <markdown [data]="messageData.reasoning"></markdown>
                      </div>
                    </mat-expansion-panel>
                  }
                  @if (messageData.hasError && messageData.error) {
                    <mat-expansion-panel class="error-expansion-panel"
                                       [expanded]="messageData.showError"
                                       (expandedChange)="toggleError(messageData.index)">
                      <mat-expansion-panel-header>
                        <mat-panel-title>
                          <mat-icon class="error-icon">bug_report</mat-icon>
                          <span class="error-title">Error Details</span>
                        </mat-panel-title>
                      </mat-expansion-panel-header>
                      <div class="error-content">
                        <div class="error-field">
                          <strong>Type:</strong> {{ messageData.error.errorType }}
                        </div>
                        <div class="error-field">
                          <strong>Time:</strong> {{ messageData.error.timestamp }}
                        </div>
                        @if (messageData.error.stackTrace) {
                          <div class="error-field">
                            <strong>Stack Trace:</strong>
                            <pre class="error-stacktrace">{{ messageData.error.stackTrace }}</pre>
                          </div>
                        }
                      </div>
                    </mat-expansion-panel>
                  }
                }
              </div>
            }
          </mat-card-content>
        </mat-card>
      </div>
    }
  </div>
  <div class="chatbox-footer">
    <ng-form style="display: flex; align-items: center; gap: 8px;">
      <button mat-icon-button type="button"
              (click)="openPromptSelection()"
              [disabled]="!hasAvailablePrompts() || isBusy()"
              [matTooltip]="hasAvailablePrompts() ? 'Select a prompt' : 'No prompts available'">
        <mat-icon [class.spinning]="isBusy()">psychology</mat-icon>
      </button>
      <mat-form-field style="flex-grow: 1">
        <input name="chatbox-input"
               placeholder="Type a message..."
               matInput
               [ngModel]="chatMessage()"
               (ngModelChange)="updateChatMessage($event)"
               [disabled]="isBusy()"
               type="text"
               (keydown.enter)="sendChatMessage()">
      </mat-form-field>
      <button mat-flat-button
              type="button"
              (click)="sendChatMessage()"
              [disabled]="!canSendMessage()"
              [matTooltip]="sendButtonTooltip()">
        {{ sendButtonText() }}
      </button>
    </ng-form>
  </div>
</div>
