<div class="chatbox" id="chatbox">
  <div #chatboxMessages class="chatbox-messages">
    <!-- Chat messages will be dynamically inserted here -->
    @for (messageData of messagesWithReasoningFlags(); track messageData.index) {
      <div [ngClass]="getMessageClasses(messageData)">
        @if (messageData.persona === 'user') {
          <!-- User message template -->
          <mat-card>
            <mat-card-content>
              <div class="user-message-content">{{ messageData.text }}</div>
            </mat-card-content>
          </mat-card>
        }
        
        @if (messageData.persona === 'bot') {
          <!-- Bot message with typing indicator support -->
          <mat-card>
            <mat-card-content>
              @if (messageData.typing) {
                <div class="typing-indicator">
                  <div class="typing__dot"></div>
                  <div class="typing__dot"></div>
                  <div class="typing__dot"></div>
                </div>
              } @else {
                <div class="bot-message-content">
                  <markdown [data]="messageData.text"></markdown>
                </div>
                <!-- Bot-specific toggles and sections -->
                <div class="message-toggles">
                  @if (messageData.hasReasoning) {
                    <button mat-icon-button 
                            class="reasoning-toggle"
                            (click)="toggleReasoning(messageData.index)"
                            [id]="messageData.reasoningToggleId"
                            [attr.aria-pressed]="messageData.showReasoning"
                            [attr.aria-label]="messageData.showReasoning ? 'Hide reasoning' : 'Show reasoning'"
                            [attr.aria-controls]="messageData.reasoningContentId"
                            [matTooltip]="messageData.showReasoning ? 'Hide reasoning' : 'Show reasoning'"
                            type="button"
                            role="button">
                      <mat-icon [attr.aria-hidden]="true">{{ messageData.showReasoning ? 'lightbulb' : 'lightbulb_outline' }}</mat-icon>
                    </button>
                  }
                  @if (messageData.hasError) {
                    <button mat-icon-button 
                            class="error-toggle"
                            (click)="toggleError(messageData.index)"
                            [id]="messageData.errorToggleId"
                            [attr.aria-pressed]="messageData.showError"
                            [attr.aria-label]="messageData.showError ? 'Hide error details' : 'Show error details'"
                            [attr.aria-controls]="messageData.errorContentId"
                            [matTooltip]="messageData.showError ? 'Hide error details' : 'Show error details'"
                            type="button"
                            role="button">
                      <mat-icon [attr.aria-hidden]="true">{{ messageData.showError ? 'error' : 'error_outline' }}</mat-icon>
                    </button>
                  }
                </div>
                @if (messageData.showReasoning && messageData.reasoning) {
                  <div class="reasoning-section" 
                       role="region" 
                       [id]="messageData.reasoningContentId"
                       [attr.aria-label]="'AI reasoning for this response'"
                       [attr.aria-expanded]="messageData.showReasoning"
                       [attr.aria-labelledby]="messageData.reasoningToggleId">
                    <div class="reasoning-header">
                      <mat-icon class="reasoning-icon" [attr.aria-hidden]="true">psychology</mat-icon>
                      <span class="reasoning-label">Reasoning</span>
                    </div>
                    <div class="reasoning-content" role="article">
                      <markdown [data]="messageData.reasoning"></markdown>
                    </div>
                  </div>
                }
                @if (messageData.showError && messageData.error) {
                  <div class="error-section" 
                       role="region" 
                       [id]="messageData.errorContentId"
                       [attr.aria-label]="'Error details for this response'"
                       [attr.aria-expanded]="messageData.showError"
                       [attr.aria-labelledby]="messageData.errorToggleId">
                    <div class="error-header">
                      <mat-icon class="error-icon" [attr.aria-hidden]="true">bug_report</mat-icon>
                      <span class="error-label">Error Details</span>
                    </div>
                    <div class="error-content" role="article">
                      <div class="error-field">
                        <strong>Type:</strong> {{ messageData.error.errorType }}
                      </div>
                      <div class="error-field">
                        <strong>Time:</strong> {{ messageData.error.timestamp }}
                      </div>
                      @if (messageData.error.stackTrace) {
                        <div class="error-field">
                          <strong>Stack Trace:</strong>
                          <pre class="error-stacktrace">{{ messageData.error.stackTrace }}</pre>
                        </div>
                      }
                    </div>
                  </div>
                }
              }
            </mat-card-content>
          </mat-card>
        }
        
        @if (messageData.persona === 'agent') {
          <!-- Agent message - no typing indicator -->
          <mat-card class="agent-message-card">
            <mat-card-content>
              <div class="agent-message-header">
                <div class="agent-avatar">
                  <mat-icon>smart_toy</mat-icon>
                </div>
                <span class="agent-name-badge">
                  {{ getAgentName(messageData.agentType) }}
                  @if (messageData.responseIndex !== undefined) {
                    <span class="response-index">#{{ messageData.responseIndex + 1 }}</span>
                  }
                </span>
                <span class="message-timestamp">
                  {{ messageData.timestamp | date:'short' }}
                </span>
              </div>
              <div class="agent-message-content">
                <markdown [data]="messageData.text"></markdown>
              </div>
            </mat-card-content>
          </mat-card>
        }
      </div>
    }
  </div>
  <div class="chatbox-footer" [class]="agentModeClass()">
    <ng-form style="display: flex; align-items: center; gap: 8px;">
      @if (selectedAgent()) {
        <!-- Agent indicator with deselect option -->
        <div class="agent-indicator">
          <mat-icon class="agent-icon" [style.color]="selectedAgent()?.color || 'var(--mat-sys-tertiary)'">{{ selectedAgent()?.icon || 'smart_toy' }}</mat-icon>
          <span class="agent-name">{{ selectedAgent()?.name }}</span>
          <button mat-icon-button
                  type="button"
                  class="deselect-agent-btn"
                  (click)="agentSelectionService.deselectAgent()"
                  [matTooltip]="'Deselect ' + selectedAgent()?.name"
                  [disabled]="isBusy()">
            <mat-icon>close</mat-icon>
          </button>
        </div>
      } @else {
        <!-- Prompt selection button -->
        <button mat-icon-button type="button"
                (click)="openPromptSelection()"
                [disabled]="!hasAvailablePrompts() || isBusy()"
                [matTooltip]="hasAvailablePrompts() ? 'Select a prompt' : 'No prompts available'">
          <mat-icon [class.spinning]="isBusy()">psychology</mat-icon>
        </button>
      }
      <mat-form-field style="flex-grow: 1" [class]="inputBorderClass()">
        <input name="chatbox-input"
               [placeholder]="selectedAgent() ? 'Message ' + selectedAgent()?.name + '...' : 'Type a message...'"
               matInput
               [ngModel]="chatMessage()"
               (ngModelChange)="updateChatMessage($event)"
               [disabled]="isBusy()"
               type="text"
               (keydown.enter)="sendChatMessage()">
      </mat-form-field>
      <button mat-flat-button
              type="button"
              (click)="sendChatMessage()"
              [disabled]="!canSendMessage()"
              [matTooltip]="sendButtonTooltip()"
              [class]="sendButtonClass()">
        {{ sendButtonText() }}
      </button>
    </ng-form>
  </div>
</div>